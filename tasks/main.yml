---
- name: Gather OS specific variables
  include_vars: "{{ item }}"
  with_first_found:
    - '{{ ansible_distribution }}-{{ ansible_distribution_major_version }}.yml'
    - '{{ ansible_distribution }}.yml'
    - '{{ ansible_os_family }}.yml'
  tags:
    - vars

- name: print ansible_facts vars
  debug:
    var: ansible_facts.ansible_local

- name: Update repositories cache on Ubuntu
  apt:
    update_cache: true
  become: true
  when: ansible_distribution == 'Ubuntu'

- name: Install required packages
  package:
    name: '{{ item }}'
    state: present
  become: true
  with_items: '{{ PACKAGES }}'

- name: Remove temporary working directory
  file:
    path: "{{ rclone_setup_tmp_dir }}"
    state: absent
  tags:
    - molecule-idempotence-notest

- name: Create temporary working directory
  file:
    path: "{{ rclone_setup_tmp_dir }}"
    state: directory
    mode: '0775'

- debug:
    var: ansible_facts.ansible_local.rclone.configured

- debug:
    var: ansible_facts.ansible_local.rclone.installed_version

- name: Perform the install steps
  include_tasks: install.yml
  when: (ansible_facts['ansible_local']['rclone']['installed'] is not true) or (ansible_facts['ansible_local']['rclone']['installed_version'] != rclone_version)

- name: Create directory for ansible custom facts
  ansible.builtin.file:
    state: directory
    recurse: yes
    path: /etc/ansible/facts.d

- name: Create facts file from template
  ansible.builtin.template:
    src: 'etc/ansible/facts.d/rclone.fact.j2'
    dest: /etc/ansible/facts.d/rclone.fact
    mode: '0755'
  register: rclone__register_facts

- name: Update Ansible facts if they were modified
  action: setup
  when: rclone__register_facts is changed

- debug:
    var: ansible_local.rclone.version

- debug:
    var: ansible_local.rclone.rclone.installed_version

- name: DEBUG
  setup:
    filter: ansible_local
